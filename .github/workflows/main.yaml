name: Deploy to Production

on:
  push:
    branches:
      - main

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: ${{ vars.GCP_REGION }}
  REPOSITORY_ID: ${{ vars.ARTIFACT_REPO_ID }}
  PIPELINE_NAME: ${{ vars.CD_PIPELINE_NAME }}
  IMAGE_NAME: ${{ vars.IMAGE_NAME }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    concurrency:
      group: deploy-${{ github.ref_name }}
      cancel-in-progress: false
    permissions:
      contents: "read"
      id-token: "write"

    steps:
      - name: Authenticate to Google Cloud (WIF)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SA_EMAIL }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Notify n8n via webhook
        env:
          N8N_WEBHOOK_URL: ${{ secrets.N8N_WEBHOOK_URL }}
          N8N_USER: ${{ secrets.N8N_USER }}
          N8N_PASS: ${{ secrets.N8N_PASS }}
        run: |
          set -euo pipefail

          RELEASE_NAMES=$(gcloud deploy releases list \
            --project=${{ env.PROJECT_ID }} \
            --region=${{ env.REGION }} \
            --delivery-pipeline=${{ env.PIPELINE_NAME }} \
            --format='value(name)' \
            | grep -oE 'release-[^/]+$' \
            | jq -R . | jq -s .)

          payload=$(jq -n \
            --arg msg "배포 완료" \
            --argjson releases "${RELEASE_NAMES}" \
            '{message: $msg, sent_at: (now|todate), releases: $releases}')

          echo "$payload" | jq .

          curl --fail --show-error --silent \
              --retry 5 --retry-all-errors --retry-delay 2 \
              -u "${N8N_USER}:${N8N_PASS}" \
              -H "Content-Type: application/json" \
              -d "${payload}" \
              "${N8N_WEBHOOK_URL}"
